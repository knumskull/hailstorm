---
- hosts: rhevm
  gather_facts: false

  vars:
    engine_url: "https://{{ rhv_dns_domain }}/ovirt-engine/api"
    username: admin@internal
   
    engine_cafile: /etc/pki/ovirt-engine/ca.pem
    datacenter: Default
    cluster: Default
    
  tasks:
    - block:
       - name: obtain SSO token
         no_log: true
         ovirt_auth:
           url: "{{ engine_url }}"
           username: "{{ username }}"
           password: "{{ root_password }}"
           ca_file: "{{ engine_cafile }}"

       - name: Ensure Datacenter "{{ datacenter }}" exists
         ovirt_datacenters:
           auth: "{{ ovirt_auth }}"
           name: "{{ datacenter }}"
           comment: "The primary datacenter"
           compatibility_version: 4.1
           quota_mode: enabled
           local: False

       - name: Ensure cluster "{{ cluster }}" exists
         ovirt_clusters:
           auth: "{{ ovirt_auth }}"
           name: "{{ cluster }}"
           data_center: "{{ datacenter }}"
           description: "cluster {{ cluster }}"
           cpu_type: "Intel Haswell-noTSX Family"
           switch_type: legacy
           compatibility_version: 4.1
           gluster: false
           ballooning: false
           ha_reservation: true
           memory_policy: server

      always:
        - name: Revoke the SSO token
          ovirt_auth:
            state: absent
            ovirt_auth: "{{ ovirt_auth }}"
